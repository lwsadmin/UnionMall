
@{
    Layout = null;
}
<div class="form-horizontal">
    <div class="goodsAdd">
        <div class="goodsType">
            @Html.Raw(ViewBag.Spec)
        </div>
        <div class="hr-line-dashed"></div>
        <table class="goodsLists table"></table>
        <label onclick="submit()" type="button" class="submit">提交</label>
    </div>
</div>
<script>

    /* 提交数据 */
    function submit() {
        var result = [];
        $(".goodsLists").find("tr").each(function () {
            var tr = $(this);
            if (tr.find("td").html() != undefined) {
                var objValue = {
                    objectId: $("input[name='Id']").val(),
                    type: 0,
                    image: '',
                    price: tr.find("input[name='price']").val(),
                    retailPrice: tr.find("input[name='RetailPrice']").val(),
                    stock: tr.find("input[name='Stock']").val(),
                    sPU: tr.find("input[name='SPU']").val(),
                };
                $(this).find("td").each(function () {
                    var valueText = "";
                    if ($(this).attr("data-value") != undefined) {
                       
                    }
                });
                result.push(objValue);
            }
        });
        console.log(result)
        //var th = document.querySelectorAll('th');
        //var thName = [];
        //th.forEach(function (e) {
        //    thName.push(e.innerText);
        //})
        //var tr = document.querySelectorAll('tr');
        //for (var i = 1, len = tr.length; i < len; i++) {
        //    var td = tr[i].children;
        //    var jsonStr = "{";
        //    for (var j = 0, length = td.length; j < length; j++) {

        //        if (j < th.length - 3) {
        //            jsonStr += '"' + thName[j] + '":"' + td[j].innerText + '",'
        //        } else {
        //            jsonStr += '"' + thName[j] + '":"' + td[j].children[0].value + '",'
        //        }

        //    }
        //    jsonStr = jsonStr.substr(0, jsonStr.length - 1)
        //    jsonStr += "}"
        //    result.push(JSON.parse(jsonStr))
        //}


    }
    var subData = {};
    var showData = [];
    var goodsType = document.querySelector(".goodsType");
    var goodTypeStr = "";

    //点击商品类型效果
    function select(ele, e, val) {
        if ($(ele).hasClass("active")) {
            $(ele).removeClass("active");
            typeDel(e, val);
        } else {
            $(ele).addClass("active");
            typeAdd(e, val);
        }
    }

    //增加一个类别
    function typeAdd(e, val) {
        var exist = false;
        for (var type in subData) {
            if (type == e) {
                exist = true;
                subData[type].push(val);
            }
        }
        if (exist == false) {
            subData[e] = [];
            subData[e].push(val);
        }
        renders(subData)
    }

    //删除一个类别
    function typeDel(e, val) {
        for (var type in subData) {
            if (type == e) {
                for (var i = 0, len = subData[type].length; i < len; i++) {
                    if (subData[type][i] == val) {
                        subData[type].splice(i, 1)
                    }
                }
            }
        }
        renders(subData)
    }

    //根据最终数据, 渲染页面
    function renders(data) {
        showData = [];
        /* 排序, 类型少的在前 */
        var sort = [];
        for (var key in data) {
            if (data[key].length != 0) {
                sort.push(data[key].length)
            }
        }
        sort.sort();
        var length = sort.length;
        for (var i = 0; i < length; i++) {
            for (var key in data) {
                if (data[key].length == sort[0]) {
                    var obj = {};
                    obj.key = key;
                    obj.val = data[key];
                    showData.push(obj)
                    sort.shift();
                }
            }
        }

        /* 排序结束 */
        var nums = 1;
        for (var key in data) {
            nums = data[key].length * nums;
        }

        var th = "<tr>";
        var showArr = [];

        for (var i = 0, len = showData.length; i < len; i++) {
            th += "<th>" + showData[i].key + "</th>";
            showArr.push(showData[i].val);
        }
        th += "<th>@L("Price")</th><th>@L("RetailPrice")</th><th>@L("Count")</th><th>SKU</th> </tr>";
        /* 将商品转换为dom节点 */
        for (var i = 0, len = showData.length; i < len; i++) {
            var data = showData[i].val;
            showData[i].dom = [];
            for (var j = 0, length = data.length; j < length; j++) {
                var str = "<td data-value='" + data[j] + "'>" + $("span[data-objid='" + data[j]+"']").html() + "</td>";
                showData[i].dom.push(str);
            }
        }

        /* 将dom元素一一合并 */
        var doms = showData[0].dom;
        for (var i = 1, len = showData.length; i < len; i++) {
            doms = matching(doms, showData[i].dom)
        }
        var tbody = "";
        for (var i = 0, len = doms.length; i < len; i++) {
            var str = "<tr>" + doms[i] + "<td><input type='number' name='price' /></td>\
                <td> <input type='number' name='RetailPrice' /></td>\
                <td> <input type='number'name='Stock' /></td> <td><input type='text' name=SKU /></td>" + "</tr > ";
            tbody += str;
        }
        var goodsLists = document.querySelector(".goodsLists");
        goodsLists.innerHTML = th + tbody;

    }

    //将两个数组内的每个元素一一匹配 (数组元素为字符串)
    function matching(arr1, arr2) {
        var arr = [];
        for (var i = 0, len = arr1.length; i < len; i++) {
            for (var j = 0, length = arr2.length; j < length; j++) {
                var str = arr1[i] + arr2[j];
                arr.push(str);
            }
        }
        return arr;
    }
</script>